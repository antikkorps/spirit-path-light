---
export interface Props {
	variant?: 'default' | 'inline' | 'centered';
	showNames?: boolean;
}

const { variant = 'default', showNames = false } = Astro.props;
---

<div class={`newsletter-container ${variant}`}>
	{variant === 'default' && (
		<div class="bg-gradient-to-r from-primary/10 to-secondary/10 dark:from-primary/20 dark:to-secondary/20 rounded-2xl p-12 text-center border border-primary/20 dark:border-primary/30 transition-colors duration-300">
			<div class="w-16 h-16 bg-gradient-to-br from-primary to-secondary rounded-full flex items-center justify-center mx-auto mb-6">
				<svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
				</svg>
			</div>
			<h3 class="text-3xl font-display font-bold text-gray-800 dark:text-gray-100 mb-4 transition-colors duration-300">
				Restez inspiré·e
			</h3>
			<p class="text-gray-600 dark:text-gray-300 mb-8 transition-colors duration-300">
				Recevez les nouveaux articles et conseils spirituels directement dans votre boîte mail
			</p>
			<form class="newsletter-form max-w-md mx-auto" data-newsletter-form>
				<div class="flex flex-col sm:flex-row gap-4">
					<input
						type="email"
						name="email"
						placeholder="Votre adresse email"
						class="flex-1 px-6 py-3 rounded-full border-2 border-gray-200 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition-colors duration-300"
						required
					/>
					<button type="submit" class="btn btn-primary rounded-full px-8 py-3 shadow-lg hover:shadow-xl transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
						S'abonner
					</button>
				</div>
				<div class="newsletter-message mt-4 text-sm"></div>
			</form>
		</div>
	)}

	{variant === 'inline' && (
		<div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-200 dark:border-gray-700 transition-colors duration-300">
			<div class="flex items-center gap-4 mb-4">
				<div class="w-12 h-12 bg-gradient-to-br from-primary to-secondary rounded-full flex items-center justify-center flex-shrink-0">
					<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
					</svg>
				</div>
				<div>
					<h4 class="font-bold text-gray-800 dark:text-gray-100 text-lg">Newsletter</h4>
					<p class="text-sm text-gray-600 dark:text-gray-400">Restez connecté·e</p>
				</div>
			</div>
			<form class="newsletter-form" data-newsletter-form>
				{showNames && (
					<div class="grid grid-cols-2 gap-3 mb-3">
						<input
							type="text"
							name="firstName"
							placeholder="Prénom"
							class="px-4 py-2 rounded-lg border-2 border-gray-200 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition-colors duration-300"
						/>
						<input
							type="text"
							name="lastName"
							placeholder="Nom"
							class="px-4 py-2 rounded-lg border-2 border-gray-200 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition-colors duration-300"
						/>
					</div>
				)}
				<div class="flex gap-2">
					<input
						type="email"
						name="email"
						placeholder="Email"
						class="flex-1 px-4 py-2 rounded-lg border-2 border-gray-200 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition-colors duration-300"
						required
					/>
					<button type="submit" class="btn btn-primary px-6 py-2 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
						OK
					</button>
				</div>
				<div class="newsletter-message mt-3 text-sm"></div>
			</form>
		</div>
	)}

	{variant === 'centered' && (
		<div class="max-w-md mx-auto text-center">
			<h3 class="text-2xl font-display font-bold text-gray-800 dark:text-gray-100 mb-3">Newsletter</h3>
			<p class="text-gray-600 dark:text-gray-300 mb-6">Ne manquez aucune inspiration</p>
			<form class="newsletter-form" data-newsletter-form>
				<input
					type="email"
					name="email"
					placeholder="Votre email"
					class="w-full px-6 py-3 rounded-full border-2 border-gray-200 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 mb-3 transition-colors duration-300"
					required
				/>
				<button type="submit" class="w-full btn btn-primary rounded-full px-8 py-3 shadow-lg hover:shadow-xl transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
					S'inscrire
				</button>
				<div class="newsletter-message mt-3 text-sm"></div>
			</form>
		</div>
	)}
</div>

<script>
	document.addEventListener('DOMContentLoaded', () => {
		const forms = document.querySelectorAll('[data-newsletter-form]');

		forms.forEach((form) => {
			form.addEventListener('submit', async (e) => {
				e.preventDefault();

				const formElement = e.target as HTMLFormElement;
				const messageContainer = formElement.querySelector('.newsletter-message') as HTMLElement;
				const submitButton = formElement.querySelector('button[type="submit"]') as HTMLButtonElement;
				const emailInput = formElement.querySelector('input[name="email"]') as HTMLInputElement;
				const firstNameInput = formElement.querySelector('input[name="firstName"]') as HTMLInputElement;
				const lastNameInput = formElement.querySelector('input[name="lastName"]') as HTMLInputElement;

				// Disable submit button
				submitButton.disabled = true;
				submitButton.textContent = 'Inscription...';

				try {
					const response = await fetch('/api/newsletter', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({
							email: emailInput.value,
							firstName: firstNameInput?.value || '',
							lastName: lastNameInput?.value || '',
						}),
					});

					const data = await response.json();

					if (data.success) {
						messageContainer.className = 'newsletter-message mt-4 text-sm text-green-600 dark:text-green-400 font-medium';
						messageContainer.textContent = data.message;
						formElement.reset();
					} else {
						messageContainer.className = 'newsletter-message mt-4 text-sm text-red-600 dark:text-red-400 font-medium';
						messageContainer.textContent = data.error || 'Une erreur est survenue';
					}
				} catch (error) {
					messageContainer.className = 'newsletter-message mt-4 text-sm text-red-600 dark:text-red-400 font-medium';
					messageContainer.textContent = 'Erreur de connexion. Veuillez réessayer.';
				} finally {
					// Re-enable submit button
					submitButton.disabled = false;
					submitButton.textContent = formElement.classList.contains('inline') ? 'OK' : 'S\'abonner';
				}
			});
		});
	});
</script>
